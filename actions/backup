#!/usr/bin/env python3

import os
import sys
import yaml
import shlex
import socket
from datetime import datetime
from subprocess import check_output
from charmhelpers.core import hookenv

hooks = hookenv.Hooks()


def get_weebl_data(weebl_yaml="/etc/weebl/weebl.yaml"):
    with open(weebl_yaml) as f:
        return yaml.load(f.read())


def save_database_dump(weebl_data, filename, timestamp_format="%F_%H-%M-%S"):
    now = datetime.now().strftime(timestamp_format)
    out = "{}_{}_{}".format(filename_socket.gethostname(), now)
    cmd = ("PGPASSWORD={password} pg_dump -h {host} -U {user} -p {port} -x -F "
           "t {database} > {output}".format(
               **weebl_data['database'], output=out))
    check_output(shlex.split(cmd))
    juju_ip, _, weebl_ip, __ = os.environ['SSH_CONNECTION'].split(' ')
    return os.path.abspath(out)


@hooks.hook("backup")
def backup(filename):
    """ Back-up current Weebl database. """
    hookenv.log("Dumping database to file")
    weebl_data = get_weebl_data()
    output_file_path = save_database_dump(weebl_data, filename)
    hookenv.log("Saved database dump to {}".format(output_file_path))
    hookenv.action_set(output_file_path)


if __name__ == "__main__":
    hooks.execute(sys.argv)



ALSO BACKUP SVGS!!!!!
